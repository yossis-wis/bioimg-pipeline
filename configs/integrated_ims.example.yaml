# Integrated Slice: Nuclei Segmentation + Spot Detection (Real Data)
# Template file. Copy to configs/local/integrated_ims.local.yaml and edit locally.

# Input can be a single file, a list, or a glob pattern.
# Use ONE of: input_relpath, input_relpaths, input_glob.
# (Paths can be absolute; absolute paths will bypass BIOIMG_DATA_ROOT.)
# input_glob: "S:/BIC/<user>/equipment/<instrument>/<date>/*/*.ims"
# input_relpath: raw_staging/my_experiment.ims
# input_relpaths:
#   - raw_staging/sample_a.ims
#   - raw_staging/sample_b.ims

# Store intermediate outputs locally under BIOIMG_DATA_ROOT.
output_runs_dir: runs
# Optionally copy final outputs to a writable storWIS location.
# publish_dir: "S:/bioimg-results/<user>/<date>"
# publish_mirror: true
# input_base_dir: "S:/BIC/<user>/equipment/<instrument>/<date>"
# publish_mode: "error"  # error | overwrite | merge

# Batch behavior
# continue_on_error: true
# skip_existing: false
# republish_skipped: false
# batch_dir_name: "2025-12-31__integrated_batch"
# batch_aggregate_spots: false

# Input Channels (1-based)
# Check your Imaris file to see which channel is DAPI (Nuclei) vs FISH (Spots)
# channel_spots can be a list, e.g. [2, 3]
# NOTE: It is valid for channel_nuclei to also appear in channel_spots
# (e.g. if your nuclei marker and DNA locus are both in the 488 channel).
channel_nuclei: 1
channel_spots: 2
# Optional: path to precomputed nuclei labels (skip StarDist)
# nuclei_labels_relpath: runs/<timestamp>__integrated/nuclei_labels.tif
# Optional: skip segmentation when no nuclei channel is present
# skip_nuclei_segmentation: true
# Optional: restrict spot detection to a boolean mask (nonzero = valid)
# valid_mask_relpath: raw_staging/my_valid_mask.tif

# Imaris Selection
ims_resolution_level: 0
ims_time_index: 0
ims_z_index: 0

# --- Nuclei Segmentation (StarDist) ---
# stardist_model_dir should point to a folder under BIOIMG_DATA_ROOT/models/
stardist_model_dir: models/y22m01d12_model_0
nuc_prob_thresh: 0.3
nuc_nms_thresh: 0.00  # 0 => strict NMS (keep only most probable in overlaps)
nuc_normalize_pmin: 1.0
nuc_normalize_pmax: 99.8

# --- Spot Detection (Slice0; TrackMate-style LoG + fixed-mask photometry) ---
# Units: all optics-ish lengths here are in **nm**.
#   - spot_pixel_size_nm is **nm / pixel** (XY).
#     Example: if Fiji/ImageJ shows 0.108 µm/pixel, then spot_pixel_size_nm: 108.0
#   - spot_lambda_nm and spot_zR must use the same length unit (nm here).
#
# TrackMate mapping (see docs/SPOT_DETECTION.md):
#   - TrackMate GUI "Estimated blob diameter"  d_TM = 2 * radius
#   - This repo stores the radius in nm (spot_radius_nm), or derives it from (lambda, zR).
spot_pixel_size_nm: auto  # auto => infer from metadata (nm/px)
spot_lambda_nm: 667
spot_zR: 344.5

# Optional: override TrackMate radius directly (nm).
# If omitted, we compute r = sqrt(lambda * zR / pi) and use radius = r.
# spot_radius_nm: null

# Optional TrackMate toggles (defaults match TrackMate defaults):
# spot_do_median_filter: false
# spot_do_subpixel_localization: false

# TrackMate uses a strict 3×3 neighborhood for local maxima (RectangleShape(1)).
spot_se_size: 3        # local-max neighborhood size (px)

# Candidate threshold on LoG response at the maximum (TrackMate "threshold").
spot_q_min: 1.0         # LoG quality threshold (q_min)

# Final acceptance threshold (UNCHANGED): u0 = mean(in5) - median(out0)
spot_u0_min: 30

# Optional per-channel overrides (multi-channel spot detection)
# -----------------------------------------------------------
# Use this when channel_spots is a list and you need different LoG / u0
# thresholds for different spot types.
#
# Example for a 2-channel DNA+protein experiment:
#   - DNA locus (LoG-only): TrackMate diameter 0.54 µm => radius 270 nm
#   - TrackMate threshold (quality) = 6.182
#
# spot_params_by_channel:
#   1:
#     spot_radius_nm: 270.0
#     spot_q_min: 6.182
#     spot_u0_min: 0.0
#   2:
#     spot_u0_min: 30.0

# --- Visual QC ---
qc_cutout_size: 80
qc_max_cutouts: 50
qc_montage_cols: 10
# qc_sample_seed: 0


